# 自助洗车机

| 修订日期           | 修订人 | 修订内容 | 修订版本 |
| :----------------- | :----: | :------- | -------: |
| 2021 年 12 月 4 日 | 韩昊轩 | 初始版本 |   v0.0.1 |
| 2022 年 2 月 13 日 | 韩昊轩 | 增加命令 |   v0.0.2 |

## 备忘录

---

**字节序为小端**

原则上尽量避免传递浮点数。
水量和泡沫量均为单精度浮点型

中文支持会在整体完善后添加。

修改请务必填写以上表格

## 硬件通讯手册

---

> 以下统称上位机为服务器，下位机为机器

服务器和硬件之间通过 TCP 长连接的方式进行通讯（长连接间隔最大可设置为 7200 秒，但为保证从服务器到硬件的通讯链路畅通，机器会以更短的时间间隔发送心跳包，服务器应对心跳包进行响应。），除非特殊说明，否则通讯以纯文本（ASCII）的格式进行，一次命令通讯最多可包含一行，行分隔符为\n。

所有有效的通讯指令均以符号 `+` 开始，以 `\n` 结束，指令头、指令和参数（或结果）以空格分隔，参数内部若需要分隔须以 `,` 分隔。

从服务器发送到机器的通讯指令需在开头添加 `+SERVCMD` 及空格。例如：

```
+SERVCMD CMD [param1] [param2] [param3] [...] \n
```

从服务器发送到机器的响应指令需在开头添加 `+SERVRESP` 及空格。例如：

```
+SERVRESP <OK|ERROR|...> [CMD] [result1] [result2] [result3] [...] \n
```

从机器发送到服务器的通讯指令在开头会有 `+CTRLCMD` 及空格。例如：

```
+CTRLCMD CMD [param1] [param2] [param3] [...] \n
```

从机器发送到服务器的响应指令在开头会有 `+CTRLRESP` 及空格。例如：

```
+CTRLRESP <OK|ERROR|...> [CMD] [result1] [result2] [result3] [...] \n
```

**请不要一次发送多条指令，否则机器仅会处理第一条指令。** 建议两次命令之间插入一定的间隔（100ms~500ms）

### 响应指令内容及其格式

> 注：所有命令的第一个参数为响应对应的通讯指令，以下省略。

-   命令执行成功
    -   响应指令：OK
    -   参数：执行结果（可选）
-   命令错误或执行失败
    -   响应指令：ERROR
    -   参数：报错信息（可选）

### 服务器 到 机器

> 注：返回的信息请参考响应指令的内容及其格式，若返回值的详细列表为无序列表，则该值为无序列表中的一项；若为有序列表，则该值为逗号分隔的全部项（result1,,result3 代表第二个返回值为空）。若不注明返回值，则默认为无结果的响应指令

#### 1. 控制命令

-   返回机器信息
    -   通讯指令：GET_STATUS
    -   参数：无
    -   返回：
        1. 机器状态
            - OK：正常
            - INUSE：正在使用
            - BROKEN：故障
        2. 机器 MAC 地址（格式：AA:BB:CC:DD:EE:FF）
        3. 机器 IP 地址（格式：1.2.3.4，硬件无 IPV6 支持）
        4. 机器时间（秒时间戳）
        5. 机器软件版本
        6. 机器信号强度
        7. 机器水量（若机器有水量传感器）
        8. 机器泡沫量（若机器有泡沫量传感器）
        9. 机器泡沫比例系数

            > 注：比例系数为使用 1 单位泡沫所相当的水量，单位为 0.001。例如若该值为 1000，代表 1 升泡沫=1 升水；1500 代表 1 升泡沫 1.5 升水。
-   用户登录
    -   通讯指令：USER_LOGIN
    -   参数：
        1. 用户 ID
        2. 用户可用水量

            > 注：机器不参与计费环节，计费环节由服务器处理。若用户使用泡沫，视为以固定比例系数用水。

        3. 用户名（ASCII）
    -   返回：
        -   若成功则无返回值
-   用户退出登录
    -   通讯指令：USER_LOGOUT
    -   参数：
        -   用户 ID
    -   返回：
        1. 用户使用的水量
        2. 用户使用的泡沫量
        3. 用户占用的时间（秒）
-   重启机器

    > 注：重启和关闭类型的指令若当前正在被使用则无法进行。

    -   通讯指令：RESET
    -   参数：无

-   关闭机器（注：该指令执行后机器无法自动启动，需要人工干预）
    -   通讯指令：SHUTDOWN
    -   参数：无
-   暂停机器服务
    -   通讯指令：SERVICE_STOP
    -   参数：无
-   开启机器服务
    -   通讯指令：SERVICE_START
    -   参数：无
-   关闭显示屏
    -   通讯指令：DISPLAY_TURNOFF
    -   参数：无
-   打开显示屏
    -   通讯指令：DISPLAY_TURNON
    -   参数：无
-   输出信息到显示屏
    -   通讯指令：DISPLAY_MESSAGE
    -   参数：
        **该指令收到之后，会将全部参数域（直到最后一个字节为止，该指令无须行尾的换行）视为一个整体进行处理，无视任何分隔符和换行**
        -   信息（二进制格式，目前暂时为 ASCII）
    -   返回：
        -   信息的字节数
-   显示二维码
    -   通讯指令：DISPLAY_QRCODE
    -   参数：
        **该指令收到之后，会将全部参数域视为一个整体进行处理（同输出信息到显示屏）**

        > 注：机器不会对二维码进行非整数倍的放大和任何缩小处理

        1. 二字节的无符号整形，代表二维码矩阵的长宽
        2. N 字节的无符号整形，代表二维码数据。
            - N = 长宽 \* 长宽 / 8，若无法整除，在后方添 0。
            - 1 代表黑点，0 代表空
            - 例如一个 5x5 中间有 1x1 方块的回字型所产生的参数为：\x05\xfc\x6b\x1f\x80
-   配置可变参数
    -   通讯指令：SET_CONF
    -   参数：
        **该指令参数为纯二进制（参考二维码）**
        1. 一字节的uint8指示修改哪个配置
        2. 二字节的uint16指示数据域长度
        3. 数据域

### 机器 到 服务器

-   开机注册指令
    -   通讯指令：REGISTER
        -   参数：
            1. 机器的 MAC 地址
            2. 机器的 IP 地址
            3. 机器时间
            4. 机器软件版本
            5. 机器信号强度
        -   返回：
            -   若服务器同意注册，则返回：
                1. 状态码 OK
                2. 服务器时间
            -   若服务器不同意注册，则返回：
                1. 状态码 ERROR
                2. 服务器时间
-   发送心跳包
    -   通讯指令：HEARTBEAT
    -   参数：
        1. 机器的 MAC 地址
        2. 机器的 IP 地址
        3. 机器时间
        4. 机器软件版本
        5. 机器信号强度
    -   返回：
        -   若成功，返回服务器时间，若长时间没有获得响应或获得 ERROR 响应，则机器进入断开链接状态
-   用户登录
    -   通讯指令：USER_LOGIN
    -   参数：
        1. 用户登录凭证（字符串）
        2. 用户密码（HASH 后字符串，HASH 算法初定为 MD5）
    -   返回：
        -   登录失败返回错误，成功则返回:
        1. 用户 ID
        2. 用户可用水量（如上）
-   用户退出登录
    -   通讯指令：USER_LOGOUT
    -   参数：
        1. 用户 ID
        2. 用户使用的水量
        3. 用户使用的泡沫量
        4. 用户占用的时间（秒）
    -   返回：
        -   成功则无返回值
-   请求二维码
    -   通讯指令：ACQUIRE_QRCODE
    -   参数：
        -   无参数
    -   返回：
        -   参考`DISPLAY_QRCODE`